From a2f92e48a58acf0a95152a58ef8cc3c3fc1b07f6 Mon Sep 17 00:00:00 2001
From: Jan Engelhardt <jengelh@inai.de>
Date: Tue, 2 Jun 2015 11:01:50 +0200
Subject: [PATCH 36/56] updater: disable updater pings

Despite auto-updater being arguably disabled (see previous commit),
Chromium would still send background requests. Kill it.
(trk:170, trk:171)
---
 .../chrome_component_updater_configurator.cc              | 10 ++++++++++
 components/update_client/update_checker.cc                | 15 ++++++++++++---
 2 files changed, 22 insertions(+), 3 deletions(-)

diff --git a/chrome/browser/component_updater/chrome_component_updater_configurator.cc b/chrome/browser/component_updater/chrome_component_updater_configurator.cc
index 36f602d..9121308 100644
--- a/chrome/browser/component_updater/chrome_component_updater_configurator.cc
+++ b/chrome/browser/component_updater/chrome_component_updater_configurator.cc
@@ -43,9 +43,11 @@ const char kSwitchFastUpdate[] = "fast-update";
 // Add "testrequest=1" attribute to the update check request.
 const char kSwitchRequestParam[] = "test-request";
 
+#if 0
 // Disables pings. Pings are the requests sent to the update server that report
 // the success or the failure of component install or update attempts.
 extern const char kSwitchDisablePings[] = "disable-pings";
+#endif
 
 // Sets the URL for updates.
 const char kSwitchUrlSource[] = "url-source";
@@ -58,8 +60,12 @@ const char kSwitchUrlSource[] = "url-source";
 // the request to the default URL source fails.
 // The value of |kDefaultUrlSource| can be overridden with
 // --component-updater=url-source=someurl.
+#if 0
 const char kDefaultUrlSource[] = "https:" COMPONENT_UPDATER_SERVICE_ENDPOINT;
 const char kAltUrlSource[] = "http:" COMPONENT_UPDATER_SERVICE_ENDPOINT;
+static const char kUpdateUrlSource[]  = "trk:170:https:" COMPONENT_UPDATER_SERVICE_ENDPOINT;
+static const char kPingUrlSource[]  = "trk:171:https:" COMPONENT_UPDATER_SERVICE_ENDPOINT;
+#endif
 
 // Disables differential updates.
 const char kSwitchDisableDeltaUpdates[] = "disable-delta-updates";
@@ -166,7 +172,9 @@ ChromeConfigurator::ChromeConfigurator(
            ",",
            &switch_values);
   fast_update_ = HasSwitchValue(switch_values, kSwitchFastUpdate);
+#if 0
   pings_enabled_ = !HasSwitchValue(switch_values, kSwitchDisablePings);
+#endif
   deltas_enabled_ = !HasSwitchValue(switch_values, kSwitchDisableDeltaUpdates);
 
 #if defined(OS_WIN)
@@ -218,10 +226,12 @@ std::vector<GURL> ChromeConfigurator::UpdateUrl() const {
   if (url_source_override_.is_valid()) {
     urls.push_back(GURL(url_source_override_));
   } else {
+#if 0
     urls.push_back(GURL(kDefaultUrlSource));
     if (fallback_to_alt_source_url_enabled_) {
       urls.push_back(GURL(kAltUrlSource));
     }
+#endif
   }
   return urls;
 }
diff --git a/components/update_client/update_checker.cc b/components/update_client/update_checker.cc
index 9a38a5a..6fe620b 100644
--- a/components/update_client/update_checker.cc
+++ b/components/update_client/update_checker.cc
@@ -128,13 +128,22 @@ bool UpdateCheckerImpl::CheckForUpdates(
 void UpdateCheckerImpl::OnRequestSenderComplete(const net::URLFetcher* source) {
   DCHECK(thread_checker_.CalledOnValidThread());
 
-  const GURL original_url(source->GetOriginalURL());
-  VLOG(1) << "Update check request went to: " << original_url.spec();
-
   int error = 0;
   std::string error_message;
   UpdateResponse update_response;
 
+  if (source == NULL) {
+    VLOG(1) << "Update request disabled";
+    request_sender_.reset();
+    const GURL tmp_url;
+    update_check_callback_.Run(tmp_url, error, error_message,
+                               update_response.results());
+    return;
+  }
+
+  const GURL original_url(source->GetOriginalURL());
+  VLOG(1) << "Update check request went to: " << original_url.spec();
+
   if (FetchSuccess(*source)) {
     std::string xml;
     source->GetResponseAsString(&xml);
-- 
2.4.3

