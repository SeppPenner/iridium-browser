# WPR Reocrd/Replay Tests

WPR Reocrd/Replay tests are tests that utilize WPR as a backend to simulate a
real backend api service point. When executing a WPR test, there is a Chrome proxy
session being set up. Inside this Chrome proxy session, there are
webpagereplay server (aka WPR server), tsProxy server, android forwarder binary,
and the wiring of these component to each other. A system diagram is available
[here](https://docs.google.com/document/d/1b6jVuhAuIWh-QRm9brDRfsiBP-eAfuGyDudU1HzkcP8/edit).

For a typical WPR Record/Replay test, there are two exeuction modes:
1. Record mode
2. Replay mode.

## Mark tests as WPR Record/Replay tests

To mark a test WPR Reocrd/Replay test, there are two annotations to mark on the test method:
1. Features annotation should have 'WPRRecordReplayTest'
2. WPRArchiveConfigFilePath that has a path points to the config json file.

Here is an [exmaple](https://paste.googleplex.com/6475117775290368).

## WPR Test Config json file

WPR test uses depdency_mmanager.base_config.BaseConfig format to store the
required WPR archive files in the GCS bucket (gs//chrome-wpr-archives). The
format of the file is described
[here](https://source.chromium.org/chromium/chromium/src/+/master:third_party/catapult/dependency_manager/dependency_manager/base_config.py;l=18-49?q=base_config.py&ss=chromium&originalUrl=https:%2F%2Fcs.chromium.org%2F).

1. config_type: should be marked 'BaseConfig'.
2. dependency_name: should be the test's unique name.
3. cloud_storage_base_folder: should be 'wpr-archives'.
4. cloud_storage_bucket: should be 'chrome-wpr-archives'.
5. file_info: should only have one entry 'linux_x86_64'. This is the host
   platform.
6. cloud_storage_hash: should be generated by tool at the time of uploading.
7. download_path: should be something like 'internal/testing/<test
   class>/data/<file_name>.wprgo.


## WPR tests running in record mode

In this mode, the WPR server forwards all the requests and responses between
the client and the backend server. Those requests and responses are also stored
locally as an archive file (typically ends with .wprgo). Those archive files are
stored in GCS bucket (gs://chrome-wpr-archives) with access control.

### Execute WPR test in record mode

To run the WPR test in record mode, a command line argument
'--wpr-enable-record' is needed.

A example command line:

```
out/X86/bin/run_chrome_java_test_wpr_tests --vv --wpr-enable-record
<test_filter>
```

After the test run, there should be a wprgo file, as untracked file, located at the same
directory of the config file annotated with WPRArchiveConfigFilePath. That wprgo
file should have the test's unique name as file name. You could then a better
memorable name into the config file, and upload to GCS via some script tool.

### Update WPR archive file via tools

WPR Record/Replay uses this
[script](third_party/catapult/dependency_manager/bin/update) to update WPR
archive files to the GCS (gs://chrome-wpr-archives). Note that the config file
should be filled with basic information such as config_type, dependency_name,
cloud_storage_base, cloud_storage_bucket, file_info, etc. Just leave the
cloud_storage_hash to be filled by the script.

The script requires 4 arguments
1. config: specify path to the config file.
2. dependency: should be the test unique name.
3. path: should be the path to the wprgo file to update to GCS.
4. platform: should be 'linux_x86_64'

A example command line:

```
third_party/catapult/dependency_manager/bin/update --config chrome/android/feed/core/javatests/src/org/chromium/chrome/browser/feed/network_fetch/test_data.json --dependency FeedNewTabPageCardInstrumentationTest#launchNTP_withMultipleFeedCardsRendered --path chrome/android/feed/core/javatests/src/org/chromium/chrome/browser/feed/network_fetch/FeedNewTabPageCardInstrumentationTest#launchNTP_withMultipleFeedCardsRendered.wprgo --platform linux_x86_64
```

Note that you do not need to match your local wprgo file with the download_path
filename in the json file. The tool will automatically rename it to match
download_path upon uploading.

## WPR tests running in replay mode

In this mode, the WPR server uses the wprgo archive file given by the config
file, and playback responses to the requests based on key/value match.

This techniques makes the test to be hermatic. WPR tests running in reply mode is suitable
for running on CI/CQ bots.


