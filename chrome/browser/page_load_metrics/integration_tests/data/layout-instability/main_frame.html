<script src="/resources/testharness.js"></script>
<script src="/script/async_buffer.js"></script>
<script>
  var buffer = new AsyncBuffer();
  window.addEventListener('message', function() {
    buffer.push(event.data);
  }, false);

  const block_for_next_cls_subframe = async () => {
    return buffer.pop().then(seen_events => {
      // This test case assumes each CLS entry is handled before the next could
      // possibly be generated.
      return seen_events[0];
    });
  };

  // Shifts the div in the subframe vertically by 60px
  const verticalSubframeShift = () => {
    document.getElementById('i').contentWindow.postMessage('shift', '*');
  };

  // Shifts the iframe right by 50% of the viewport.
  const horizontalIframeShift = () => {
    document.getElementById('i').style.left = '600px';
    document.getElementById('i').contentWindow.postMessage('unshift', '*');
  };

  const run_test = async () => {
    // This test exerciess the following scenario
    //  - Shift a div in an iframe vertically
    //  - Report the layout shift to the test
    //  - Shift the div back, and at the same time, shift the iframe
    //    horizontally halfway outside the viewport.
    //  - Report the layout shift to the test
    verticalSubframeShift();
    const cls_0 = await block_for_next_cls_subframe();
    horizontalIframeShift();
    const cls_1 = await block_for_next_cls_subframe();

    // Now that we've run through the scenario and collected our measurements,
    // return them in a structure that the C++ side can easily query.
    let output = [
      {'score': cls_0.value},
      {'score': cls_1.value}
    ];
    return output;
  };

</script>
<style>
  #i {
    border: 0;
    position: absolute;
    left: 0;
    top: 0;
    background-color: pink;
  }
</style>
<iframe id="i" width="400" height="300"
        src="/cross-site/foo.com/layout-instability/sub_frame.html"></iframe>