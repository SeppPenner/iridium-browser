From 2aa30a564490a23dd1c3d695e6e819ef2c7ac4dd Mon Sep 17 00:00:00 2001
From: Jan Engelhardt <jengelh@inai.de>
Date: Mon, 7 Sep 2020 10:37:24 +0200
Subject: [PATCH 32/76] SUSE chromium-vaapi-fix.patch

description: fix vaapi with vdpau
author: Maxim Baz
origin: chromium-vaapi patches from Arch linux
---
 media/gpu/vaapi/vaapi_video_decode_accelerator.cc | 14 ++++++++++++--
 media/gpu/vaapi/vaapi_video_decode_accelerator.h  |  1 +
 media/gpu/vaapi/vaapi_wrapper.cc                  |  5 +++++
 media/gpu/vaapi/vaapi_wrapper.h                   |  3 +++
 4 files changed, 21 insertions(+), 2 deletions(-)

diff --git media/gpu/vaapi/vaapi_video_decode_accelerator.cc media/gpu/vaapi/vaapi_video_decode_accelerator.cc
index 63ea51830eed9..df14193deaca1 100644
--- media/gpu/vaapi/vaapi_video_decode_accelerator.cc
+++ media/gpu/vaapi/vaapi_video_decode_accelerator.cc
@@ -677,6 +677,7 @@ void VaapiVideoDecodeAccelerator::AssignPictureBuffers(
   // |vpp_vaapi_wrapper_| for VaapiPicture to DownloadFromSurface() the VA's
   // internal decoded frame.
   if (buffer_allocation_mode_ != BufferAllocationMode::kNone &&
+      buffer_allocation_mode_ != BufferAllocationMode::kWrapVdpau &&
       !vpp_vaapi_wrapper_) {
     vpp_vaapi_wrapper_ = VaapiWrapper::Create(
         VaapiWrapper::kVideoProcess, VAProfileNone,
@@ -708,7 +709,8 @@ void VaapiVideoDecodeAccelerator::AssignPictureBuffers(
             : gfx::Size();
 
     std::unique_ptr<VaapiPicture> picture = vaapi_picture_factory_->Create(
-        (buffer_allocation_mode_ == BufferAllocationMode::kNone)
+        ((buffer_allocation_mode_ == BufferAllocationMode::kNone) ||
+         (buffer_allocation_mode_ == BufferAllocationMode::kWrapVdpau))
             ? vaapi_wrapper_
             : vpp_vaapi_wrapper_,
         make_context_current_cb_, bind_image_cb_, buffer, size_to_bind);
@@ -1164,6 +1166,14 @@ VaapiVideoDecodeAccelerator::GetSupportedProfiles() {
 
 VaapiVideoDecodeAccelerator::BufferAllocationMode
 VaapiVideoDecodeAccelerator::DecideBufferAllocationMode() {
+  // NVIDIA blobs use VDPAU
+  if (base::StartsWith(VaapiWrapper::GetVendorString(),
+              "Splitted-Desktop Systems VDPAU",
+              base::CompareCase::SENSITIVE)) {
+    LOG(INFO) << "VA-API driver on VDPAU backend";
+    return BufferAllocationMode::kWrapVdpau;
+  }
+
   // TODO(crbug.com/912295): Enable a better BufferAllocationMode for IMPORT
   // |output_mode_| as well.
   if (output_mode_ == VideoDecodeAccelerator::Config::OutputMode::IMPORT)
@@ -1174,7 +1184,7 @@ VaapiVideoDecodeAccelerator::DecideBufferAllocationMode() {
   // associated format reconciliation copy, avoiding all internal buffer
   // allocations.
   // TODO(crbug.com/911754): Enable for VP9 Profile 2.
-  if (IsGeminiLakeOrLater() &&
+  if (false && IsGeminiLakeOrLater() &&
       (profile_ == VP9PROFILE_PROFILE0 || profile_ == VP8PROFILE_ANY ||
        (profile_ >= H264PROFILE_MIN && profile_ <= H264PROFILE_MAX))) {
     // Add one to the reference frames for the one being currently egressed, and
diff --git media/gpu/vaapi/vaapi_video_decode_accelerator.h media/gpu/vaapi/vaapi_video_decode_accelerator.h
index 62b90c8585897..d0b06eb95d01d 100644
--- media/gpu/vaapi/vaapi_video_decode_accelerator.h
+++ media/gpu/vaapi/vaapi_video_decode_accelerator.h
@@ -209,6 +209,7 @@ class MEDIA_GPU_EXPORT VaapiVideoDecodeAccelerator
     // Using |client_|s provided PictureBuffers and as many internally
     // allocated.
     kNormal,
+    kWrapVdpau,
   };
 
   // Decides the concrete buffer allocation mode, depending on the hardware
diff --git media/gpu/vaapi/vaapi_wrapper.cc media/gpu/vaapi/vaapi_wrapper.cc
index ad898555fe7f4..a8a614ee4d226 100644
--- media/gpu/vaapi/vaapi_wrapper.cc
+++ media/gpu/vaapi/vaapi_wrapper.cc
@@ -1178,6 +1178,11 @@ VAImplementation VaapiWrapper::GetImplementationType() {
   return VASupportedProfiles::Get().GetImplementationType();
 }
 
+// static
+const std::string& VaapiWrapper::GetVendorString() {
+  return VADisplayState::Get()->va_vendor_string();
+}
+
 // static
 scoped_refptr<VaapiWrapper> VaapiWrapper::Create(
     CodecMode mode,
diff --git media/gpu/vaapi/vaapi_wrapper.h media/gpu/vaapi/vaapi_wrapper.h
index c4d005ba45600..8618233d46842 100644
--- media/gpu/vaapi/vaapi_wrapper.h
+++ media/gpu/vaapi/vaapi_wrapper.h
@@ -121,6 +121,9 @@ class MEDIA_GPU_EXPORT VaapiWrapper
   // Returns the type of the underlying VA-API implementation.
   static VAImplementation GetImplementationType();
 
+  // Returns the VAAPI vendor string (obtained using vaQueryVendorString()).
+  static const std::string& GetVendorString();
+
   // Return an instance of VaapiWrapper initialized for |va_profile| and
   // |mode|. |report_error_to_uma_cb| will be called independently from
   // reporting errors to clients via method return values.
-- 
2.29.1

