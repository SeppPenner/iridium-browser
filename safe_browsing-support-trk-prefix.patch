From 1be1d641cab397ff32c14128fd4e2bcb42cc1a32 Mon Sep 17 00:00:00 2001
From: Joachim Bauch <jojo@struktur.de>
Date: Mon, 6 Jul 2015 18:18:03 +0200
Subject: [PATCH 48/56] safe_browsing: support trk: prefix

---
 chrome/browser/safe_browsing/protocol_manager.cc | 4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

diff --git a/chrome/browser/safe_browsing/protocol_manager.cc b/chrome/browser/safe_browsing/protocol_manager.cc
index 234a0e7..d5acbe2 100644
--- a/chrome/browser/safe_browsing/protocol_manager.cc
+++ b/chrome/browser/safe_browsing/protocol_manager.cc
@@ -739,10 +739,12 @@ GURL SafeBrowsingProtocolManager::GetHashUrl() const {
 GURL SafeBrowsingProtocolManager::NextChunkUrl(const std::string& url) const {
   DCHECK(CalledOnValidThread());
   std::string next_url;
+  const std::string url_prefix_without_trk(
+      GURL(url_prefix_).strip_trk().spec());
   if (!StartsWithASCII(url, "http://", false) &&
       !StartsWithASCII(url, "https://", false)) {
     // Use https if we updated via https, otherwise http (useful for testing).
-    if (StartsWithASCII(url_prefix_, "https://", false))
+    if (StartsWithASCII(url_prefix_without_trk, "https://", false))
       next_url.append("https://");
     else
       next_url.append("http://");
-- 
2.4.3

